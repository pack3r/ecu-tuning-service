<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>K贸ko i Krzy偶yk - Serwis Plik贸w</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
      .game-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        text-align: center;
      }

      .game-board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        width: 300px;
        height: 300px;
        margin: 2rem auto;
      }

      .game-cell {
        width: 100%;
        height: 100%;
        border: 2px solid #333;
        background: white;
        font-size: 4rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
      }

      .game-cell:hover {
        background-color: #f0f0f0;
      }

      .game-cell.occupied {
        cursor: not-allowed;
      }

      .game-cell.occupied:hover {
        background-color: white;
      }

      .game-status {
        font-size: 1.5rem;
        margin: 1rem 0;
        padding: 1rem;
        border-radius: 8px;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .waiting-user {
        background-color: #fef3c7;
        color: #92400e;
      }

      .waiting-admin {
        background-color: #fee2e2;
        color: #dc2626;
      }

      .playing {
        background-color: #d1fae5;
        color: #065f46;
      }

      .finished {
        background-color: #e0e7ff;
        color: #3730a3;
      }

      .reset-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
      }

      .reset-btn:hover {
        background: #b91c1c;
      }

      .reset-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Serwis Plik贸w</div>
      <nav>
        <% if (isAdmin) { %>
          <a href="/admin/jobs" class="btn">Panel Administratora</a>
        <% } else { %>
          <a href="/jobs/new" class="btn">Nowe Zadanie</a>
          <a href="/jobs/history" class="btn">Historia Zada</a>
        <% } %>
        <a href="/home" class="btn">Strona G贸wna</a>
        <span style="color: #6b7280; font-size: 0.9rem; margin-left: 1rem;"> Gra tymczasowo niedostpna</span>
        <form action="/logout" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-secondary">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <div class="game-container">
        <h1>K贸ko i Krzy偶yk</h1>
        <p>Wsp贸lna gra dla wszystkich u偶ytkownik贸w</p>

        <div id="game-status" class="game-status waiting-user">
          adowanie gry...
        </div>

        <div class="game-board" id="game-board">
          <% for (let i = 0; i < 9; i++) { %>
            <div class="game-cell" data-position="<%= i %>">
              <%= game.board[i] || '' %>
            </div>
          <% } %>
        </div>

        <% if (isAdmin) { %>
          <button id="reset-btn" class="reset-btn">Resetuj Gr</button>
        <% } %>

        <div style="margin-top: 2rem;">
          <p><strong>Zasady:</strong></p>
          <ul style="text-align: left; display: inline-block;">
            <li>U偶ytkownicy graj jako <strong>X</strong></li>
            <li>Administrator gra jako <strong>O</strong></li>
            <li>Ruchy wykonywane s naprzemiennie</li>
            <li>Pierwszestwo maj u偶ytkownicy</li>
            <li>Gra koczy si gdy kto wygra lub bdzie remis</li>
          </ul>
        </div>
      </div>
    </main>

    <script>
      const socket = io();
      const userIsAdmin = <%= isAdmin ? 'true' : 'false' %>;
      let currentGame = <%- JSON.stringify(game) %>;

      // Join game room
      socket.emit('joinGame');

      // Update game board
      function updateBoard(board) {
        for (let i = 0; i < 9; i++) {
          const cell = document.querySelector(`[data-position="${i}"]`);
          cell.textContent = board[i] || '';
          if (board[i]) {
            cell.classList.add('occupied');
          } else {
            cell.classList.remove('occupied');
          }
        }
      }

      // Update game status
      function updateStatus(game) {
        const statusDiv = document.getElementById('game-status');

        if (game.game_status === 'finished') {
          if (game.winner === 'draw') {
            statusDiv.textContent = 'Remis!';
            statusDiv.className = 'game-status finished';
          } else if (game.winner === 'X') {
            statusDiv.textContent = 'U偶ytkownicy wygrali! ';
            statusDiv.className = 'game-status finished';
          } else if (game.winner === 'O') {
            statusDiv.textContent = 'Administrator wygra! ';
            statusDiv.className = 'game-status finished';
          }
        } else if (game.current_turn === 'user') {
          if (userIsAdmin) {
            statusDiv.textContent = 'Oczekiwanie na ruch u偶ytkownika...';
            statusDiv.className = 'game-status waiting-user';
          } else {
            statusDiv.textContent = 'Tw贸j ruch! Kliknij na plansz.';
            statusDiv.className = 'game-status playing';
          }
        } else if (game.current_turn === 'admin') {
          if (userIsAdmin) {
            statusDiv.textContent = 'Tw贸j ruch! Kliknij na plansz.';
            statusDiv.className = 'game-status playing';
          } else {
            statusDiv.textContent = 'Oczekiwanie na ruch administratora...';
            statusDiv.className = 'game-status waiting-admin';
          }
        }
      }

      // Initialize game
      updateBoard(currentGame.board);
      updateStatus(currentGame);

      // Handle cell clicks
      document.querySelectorAll('.game-cell').forEach(cell => {
        cell.addEventListener('click', async (event) => {
          console.log('Cell clicked:', event.target);
          const position = parseInt(cell.dataset.position);
          console.log('Position:', position, 'Occupied:', cell.classList.contains('occupied'));

          if (cell.classList.contains('occupied')) {
            console.log('Cell is occupied, ignoring click');
            return;
          }

          console.log('Making move to position:', position);
          try {
            const response = await fetch('/api/game/move', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ position }),
            });

            const result = await response.json();
            console.log('Move result:', result);

            if (!result.success) {
              alert(result.error || 'Bd wykonania ruchu');
            }
          } catch (error) {
            console.error('Error making move:', error);
            alert('Bd wykonania ruchu');
          }
        });
      });

      // Handle reset button
      if (userIsAdmin) {
        document.getElementById('reset-btn').addEventListener('click', async () => {
          if (!confirm('Czy na pewno chcesz zresetowa gr?')) return;

          try {
            const response = await fetch('/api/game/reset', {
              method: 'POST',
            });

            const result = await response.json();

            if (!result.success) {
              alert(result.error || 'Bd resetowania gry');
            }
          } catch (error) {
            console.error('Error resetting game:', error);
            alert('Bd resetowania gry');
          }
        });
      }

      // Listen for game updates
      socket.on('gameUpdate', (data) => {
        currentGame = {
          board: data.board,
          current_turn: data.current_turn,
          game_status: data.game_status,
          winner: data.winner
        };

        updateBoard(data.board);
        updateStatus(currentGame);
      });

      // Listen for game reset
      socket.on('gameReset', (data) => {
        currentGame = {
          board: data.board,
          current_turn: data.current_turn,
          game_status: data.game_status,
          winner: null
        };

        updateBoard(data.board);
        updateStatus(currentGame);
      });
    </script>
  </body>
  </html>
