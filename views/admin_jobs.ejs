<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - Zadania - Serwis Plik贸w</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Panel administracyjny</div>
      <nav>
        <div class="phone-number"> +48 533 193 112</div>
        <form method="post" action="/logout">
          <button type="submit" class="btn">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <h1>Wszystkie zadania</h1>
      <section class="card">
        <% if (!jobs || jobs.length === 0) { %>
        <p>Brak zada.</p>
        <% } else { %>
        <table class="table">
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th style="width: 150px;">Klient</th>
              <th style="width: 200px;">Pojazd</th>
              <th style="width: 150px;">Sterownik ECU</th>
              <th style="width: 200px;">Plik oryginalny</th>
              <th style="width: 250px;">Opcje</th>
              <th style="width: 250px;">Notatki</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 150px;">Utworzono</th>
              <th style="width: 100px;">Szczeg贸y</th>
              <th style="width: 100px;">Oryginalny</th>
              <th style="width: 150px;">Przetworzony</th>
            </tr>
          </thead>
          <tbody>
            <% 
            function translateStatus(status) {
              const statusMap = {
                'pending': 'Oczekujce',
                'completed': 'Zakoczone',
                'processing': 'W trakcie',
                'cancelled': 'Anulowane'
              };
              return statusMap[status] || status;
            }
            %>
            <% jobs.forEach(function(job) { %>
            <tr>
              <td><%= job.id %></td>
              <td><%= job.user_email %></td>
              <td>
                <% if (job.vehicle_make && job.vehicle_model && job.vehicle_year) { %>
                <%= job.vehicle_make %> <%= job.vehicle_model %> (<%= job.vehicle_year %>)
                <% } else { %>
                <span style="color: #9ca3af;">-</span>
                <% } %>
              </td>
              <td>
                <% if (job.ecu_controller) { %>
                <%= job.ecu_controller %>
                <% } else { %>
                <span style="color: #9ca3af;">-</span>
                <% } %>
              </td>
              <td><%= job.original_filename %></td>
              <td>
                <%
                const opts = JSON.parse(job.options || '{}');
                const optionLabels = {
                  'dpf_off': 'Wyczenie DPF',
                  'egr_off': 'Wyczenie EGR',
                  'adblue_off': 'Wyczenie AdBlue',
                  'dtc_off': 'Wyczenie DTC',
                  'immo_off': 'Wyczenie IMMO'
                };
                %>
                <ul class="options-list">
                  <% Object.keys(opts).forEach(function(key) {
                    if (key === 'dtc_codes' && opts[key]) { %>
                  <li><strong>Kody bd贸w DTC:</strong> <%= opts[key] %></li>
                  <% } else if (opts[key] && key !== 'dtc_codes') { %>
                  <li><%= optionLabels[key] || key %></li>
                  <% }
                  }); %>
                </ul>
              </td>
              <td>
                <% if (job.notes) { %>
                <%= job.notes %>
                <% } else { %>
                <span style="color: #9ca3af;">Brak notatek</span>
                <% } %>
              </td>
              <td><%= translateStatus(job.status) %></td>
              <td>
                <%= job.created_at %>
                <%
                const created = new Date(job.created_at);
                const updated = new Date(job.updated_at);
                const diffMs = updated - created;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins > 1) {
                %>
                <span style="color: #059669; font-size: 0.7rem; margin-left: 0.25rem;">(edytowane)</span>
                <%
                }
                %>
              </td>
              <td>
                <a href="/admin/jobs/<%= job.id %>" class="btn-sm">Szczeg贸y</a>
              </td>
              <td>
                <a href="/admin/jobs/<%= job.id %>/original" class="btn-sm">Pobierz</a>
              </td>
              <td>
                <% if (job.processed_filename) { %>
                <span>Przesano</span>
                <% } %>
                <form method="post" action="/admin/jobs/<%= job.id %>/complete" enctype="multipart/form-data">
                  <input type="file" name="processed_file" required />
                  <button type="submit" class="btn-sm">Przelij</button>
                </form>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        <% } %>
      </section>
    </main>
  </body>
  </html>
