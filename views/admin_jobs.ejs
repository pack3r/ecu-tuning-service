<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - Zadania - Serwis Plik贸w</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Panel administracyjny</div>
      <nav>
        <a href="/admin/jobs" class="btn">Zadania</a>
        <a href="/admin/complaints" class="btn" id="complaints-btn">Reklamacje</a>
        <a href="/admin/users" class="btn">U偶ytkownicy</a>
        <div class="phone-number"> +48 533 193 112</div>
        <form method="post" action="/logout">
          <button type="submit" class="btn">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <h1>Wszystkie zadania</h1>
      <div id="notification" style="display: none; background: #10b981; color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        Nowe zadanie zostao dodane przez u偶ytkownika!
      </div>
      <div id="problem-notification" style="display: none; background: #dc2626; color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        <strong>Problem zgoszony!</strong> Klient zgosi problem ze zleceniem.
        <a href="#" id="problem-link" style="color: white; text-decoration: underline;">Zobacz szczeg贸y</a>
      </div>
      <section class="card">
        <% if (!jobs || jobs.length === 0) { %>
        <p>Brak zada.</p>
        <% } else { %>
        <table class="table">
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th style="width: 150px;">Klient</th>
              <th style="width: 200px;">Pojazd</th>
              <th style="width: 150px;">Sterownik ECU</th>
              <th style="width: 200px;">Plik oryginalny</th>
              <th style="width: 250px;">Opcje</th>
              <th style="width: 250px;">Notatki</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 150px;">Utworzono</th>
              <th style="width: 100px;">Szczeg贸y</th>
              <th style="width: 100px;">Oryginalny</th>
              <th style="width: 150px;">Przetworzony</th>
            </tr>
          </thead>
          <tbody>
            <% 
            function translateStatus(status) {
              const statusMap = {
                'pending': 'Oczekujce',
                'completed': 'Zakoczone',
                'processing': 'W trakcie',
                'cancelled': 'Anulowane'
              };
              return statusMap[status] || status;
            }
            %>
            <% jobs.forEach(function(job) { %>
            <tr>
              <td><%= job.id %></td>
              <td><%= job.user_email %></td>
              <td>
                <% if (job.vehicle_make && job.vehicle_model && job.vehicle_year) { %>
                <%= job.vehicle_make %> <%= job.vehicle_model %> (<%= job.vehicle_year %>)
                <% } else { %>
                <span style="color: #9ca3af;">-</span>
                <% } %>
              </td>
              <td>
                <% if (job.ecu_controller) { %>
                <%= job.ecu_controller %>
                <% } else { %>
                <span style="color: #9ca3af;">-</span>
                <% } %>
              </td>
              <td><%= job.original_filename %></td>
              <td>
                <%
                const opts = JSON.parse(job.options || '{}');
                const optionLabels = {
                  'dpf_off': 'Wyczenie DPF',
                  'egr_off': 'Wyczenie EGR',
                  'adblue_off': 'Wyczenie AdBlue',
                  'dtc_off': 'Wyczenie DTC',
                  'immo_off': 'Wyczenie IMMO'
                };
                %>
                <ul class="options-list">
                  <% Object.keys(opts).forEach(function(key) {
                    if (key === 'dtc_codes' && opts[key]) { %>
                  <li><strong>Kody bd贸w DTC:</strong> <%= opts[key] %></li>
                  <% } else if (opts[key] && key !== 'dtc_codes') { %>
                  <li><%= optionLabels[key] || key %></li>
                  <% }
                  }); %>
                </ul>
              </td>
              <td>
                <% if (job.notes) { %>
                <%= job.notes %>
                <% } else { %>
                <span style="color: #9ca3af;">Brak notatek</span>
                <% } %>
              </td>
              <td><%= translateStatus(job.status) %></td>
              <td>
                <%= job.created_at %>
                <%
                const created = new Date(job.created_at);
                const updated = new Date(job.updated_at);
                const diffMs = updated - created;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins > 1) {
                %>
                <span style="color: #059669; font-size: 0.7rem; margin-left: 0.25rem;">(edytowane)</span>
                <%
                }
                %>
              </td>
              <td>
                <a href="/admin/jobs/<%= job.id %>" class="btn-sm">Szczeg贸y</a>
              </td>
              <td>
                <a href="/admin/jobs/<%= job.id %>/original" class="btn-sm">Pobierz</a>
              </td>
              <td>
                <% if (job.processed_filename) { %>
                <span>Przesano</span>
                <% } %>
                <form method="post" action="/admin/jobs/<%= job.id %>/complete" enctype="multipart/form-data">
                  <input type="file" name="processed_file" required />
                  <button type="submit" class="btn-sm">Przelij</button>
                </form>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        <% } %>
      </section>
    </main>

    <footer style="background: #1f2937; color: white; padding: 1rem; text-align: center; margin-top: 2rem;">
      <div style="max-width: 1200px; margin: 0 auto;">
        <p style="margin: 0; font-size: 0.9rem;">漏 2026 Serwis Plik贸w ECU - Panel Administracyjny - Wersja 2.0.0</p>
      </div>
    </footer>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      socket.emit('joinAdmin');

      socket.on('newJob', (jobData) => {
        const notification = document.getElementById('notification');
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 30000); // Hide after 30 seconds
      });

      socket.on('problemReport', (reportData) => {
        const problemNotification = document.getElementById('problem-notification');
        const problemLink = document.getElementById('problem-link');
        problemLink.href = `/admin/jobs/${reportData.job_id}`;
        problemNotification.style.display = 'block';
      });

      socket.on('problemResolved', (data) => {
        // Check if the resolved problem matches the current notification
        const problemLink = document.getElementById('problem-link');
        if (problemLink && problemLink.href.includes(`/admin/jobs/${data.job_id}`)) {
          const problemNotification = document.getElementById('problem-notification');
          problemNotification.style.display = 'none';
        }
      });

      // Check for open problems on page load and keep notifications visible
      function checkProblems() {
        fetch('/api/admin/open-problems')
          .then(res => res.json())
          .then(problems => {
            const complaintsBtn = document.getElementById('complaints-btn');
            if (problems.length > 0) {
              complaintsBtn.style.backgroundColor = '#dc2626';
              complaintsBtn.style.color = 'white';
              complaintsBtn.style.border = '2px solid #dc2626';

              const problemNotification = document.getElementById('problem-notification');
              const problemLink = document.getElementById('problem-link');
              problemLink.href = `/admin/jobs/${problems[0].job_id}`;
              problemNotification.style.display = 'block';
            } else {
              complaintsBtn.style.backgroundColor = '#e5e7eb';
              complaintsBtn.style.color = '#111827';
              complaintsBtn.style.border = 'none';
            }
          })
          .catch(err => console.error('Error checking open problems:', err));
      }

      checkProblems();
    </script>
  </body>
  </html>
