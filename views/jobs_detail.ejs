<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Szczeg√≥≈Çy zlecenia #<%= job.id %> - Serwis Plik√≥w</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Serwis Plik√≥w</div>
      <nav>
        <a href="/home" class="btn">Panel g≈Ç√≥wny</a>
        <a href="/jobs/new" class="btn">Nowe zadanie</a>
        <a href="/jobs/history" class="btn">Historia zada≈Ñ</a>
        <div class="phone-number">üìû +48 533 193 112</div>
        <form method="post" action="/logout">
          <button type="submit" class="btn">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <h1>Szczeg√≥≈Çy zlecenia #<%= job.id %></h1>

      <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
          <!-- Chat (Left Side) -->
          <div>
            <h2 style="margin-top: 0;">Czat</h2>
            <div id="chat-messages" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; height: 300px; overflow-y: auto; background: #f9fafb; margin-bottom: 1rem;">
              <!-- Messages will be loaded here -->
            </div>
            <form id="chat-form" style="display: flex; gap: 0.5rem;">
              <input type="text" id="chat-input" placeholder="Wpisz wiadomo≈õƒá..." style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" required />
              <button type="submit" class="btn btn-primary">Wy≈õlij</button>
            </form>
          </div>

          <!-- Information Sections (Right Side) -->
          <div>
            <!-- Basic Information -->
            <div style="margin-bottom: 2rem;">
              <h2 style="margin-top: 0;">Informacje podstawowe</h2>
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                <strong>ID zadania:</strong>
                <span><%= job.id %></span>

                <strong>Status:</strong>
                <span>
                  <%
                  const statusMap = {
                    'pending': 'OczekujƒÖce',
                    'completed': 'Zako≈Ñczone',
                    'processing': 'W trakcie',
                    'cancelled': 'Anulowane'
                  };
                  %>
                  <%= statusMap[job.status] || job.status %>
                </span>

                <strong>Data utworzenia:</strong>
                <span><%= job.created_at %></span>

                <strong>Ostatnia aktualizacja:</strong>
                <span><%= job.updated_at %></span>
              </div>
            </div>

            <!-- File Information -->
            <div style="margin-bottom: 2rem;">
              <h2>Informacje o pliku</h2>
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                <strong>Nazwa oryginalna:</strong>
                <span><%= job.original_filename %></span>

                <strong>Plik przetworzony:</strong>
                <span><%= job.processed_filename ? 'Tak' : 'Nie' %></span>
              </div>

              <% if (job.processed_filename && job.status === 'completed') { %>
              <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <a href="/jobs/<%= job.id %>/download" class="btn btn-primary">Pobierz przetworzony plik</a>
                <form method="post" action="/jobs/<%= job.id %>/report_problem" style="display: inline;">
                  <button type="submit" class="btn" style="background: #dc2626; color: white;">Zg≈Ço≈õ problem</button>
                </form>
              </div>
              <% } %>
            </div>

            <!-- Vehicle Information -->
            <div style="margin-bottom: 2rem;">
              <h2>Informacje o poje≈∫dzie</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Marka:</strong><br>
                  <%= job.vehicle_make || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Model:</strong><br>
                  <%= job.vehicle_model || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Rok produkcji:</strong><br>
                  <%= job.vehicle_year || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Sterownik ECU:</strong><br>
                  <%= job.ecu_controller || 'Nie podano' %>
                </div>
              </div>
            </div>

            <!-- Tuning Options -->
            <div style="margin-bottom: 2rem;">
              <h2>Wybrane opcje tuningu</h2>
              <%
              const opts = JSON.parse(job.options || '{}');
              const optionLabels = {
                'dpf_off': 'DPF OFF',
                'egr_off': 'EGR OFF',
                'adblue_off': 'AdBlue OFF',
                'dtc_off': 'DTC OFF',
                'immo_off': 'IMMO OFF'
              };
              %>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <% Object.keys(optionLabels).forEach(function(key) { %>
                <div class="<%= opts[key] ? 'option-selected' : 'option-not-selected' %>">
                  <strong><%= optionLabels[key] %></strong><br>
                  <span class="<%= opts[key] ? 'option-text-selected' : 'option-text-not-selected' %>">
                    <%= opts[key] ? '‚úì' : '‚úó' %>
                  </span>
                </div>
                <% }); %>
              </div>

              <% if (opts.dtc_codes) { %>
              <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #d97706;">
                <strong>Kody b≈Çƒôd√≥w DTC:</strong><br>
                <span style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; display: inline-block;">
                  <%= opts.dtc_codes %>
                </span>
              </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <% if (job.notes) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Twoje notatki</h2>
          <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; border-left: 4px solid #6b7280;">
            <%= job.notes.replace(/\n/g, '<br>') %>
          </div>
        </div>
        <% } %>

        <!-- Client Message -->
        <% if (job.client_message) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Wiadomo≈õƒá od administratora</h2>
          <div style="padding: 1rem; background: #dcfce7; border-radius: 0.5rem; border-left: 4px solid #16a34a;">
            <%= job.client_message.replace(/\n/g, '<br>') %>
          </div>
        </div>
        <% } %>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
          <a href="/jobs/history" class="btn">‚Üê Powr√≥t do historii zada≈Ñ</a>
        </div>
      </div>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const jobId = <%= job.id %>;
      const chatMessages = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');

      socket.emit('joinJob', jobId);

      function loadMessages() {
        fetch(`/api/jobs/${jobId}/messages`)
          .then(res => res.json())
          .then(messages => {
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.style.marginBottom = '0.5rem';
              div.style.padding = '0.5rem';
              div.style.borderRadius = '0.375rem';
              div.style.background = msg.user_role === 'admin' ? '#e0f2fe' : '#f3f4f6';
              div.innerHTML = '<strong style="color: ' + (msg.user_role === 'admin' ? 'red' : 'darkblue') + ';">' + msg.user_name + ':</strong> ' + msg.message;
              chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Check if client can send messages
            const jobCompleted = '<%= job.status %>' === 'completed';
            const adminSentMessage = messages.some(msg => msg.user_role === 'admin');
            const hasOpenProblem = <%= job.hasOpenProblem ? 'true' : 'false' %>;
            const canSend = (adminSentMessage && !jobCompleted) || (jobCompleted && hasOpenProblem);
            const waitingMsg = document.getElementById('waiting-msg');
            if (canSend) {
              chatForm.style.display = 'flex';
              if (waitingMsg) waitingMsg.remove();
            } else {
              chatForm.style.display = 'none';
              let message = '';
              if (jobCompleted) {
                message = 'Zadanie zosta≈Ço zako≈Ñczone - czat jest zamkniƒôty';
              } else if (!adminSentMessage) {
                message = 'Czekaj na wiadomo≈õƒá od administratora';
              }
              if (message && !waitingMsg) {
                const waitingDiv = document.createElement('div');
                waitingDiv.id = 'waiting-msg';
                waitingDiv.textContent = message;
                waitingDiv.style.padding = '1rem';
                waitingDiv.style.background = jobCompleted ? '#f3f4f6' : '#fef3c7';
                waitingDiv.style.borderRadius = '0.5rem';
                waitingDiv.style.textAlign = 'center';
                waitingDiv.style.marginTop = '1rem';
                chatMessages.parentNode.insertBefore(waitingDiv, chatForm);
              }
            }
          });
      }

      loadMessages();

      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          fetch(`/api/jobs/${jobId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          })
          .then(res => res.json())
          .then(data => {
            chatInput.value = '';
          });
        }
      });

      socket.on('newMessage', (message) => {
        loadMessages();
      });
    </script>
  </body>
  </html>
