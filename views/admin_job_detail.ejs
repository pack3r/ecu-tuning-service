<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Szczeg√≥≈Çy zadania #<%= job.id %> - Serwis Plik√≥w</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Panel administracyjny</div>
      <nav>
        <a href="/admin/jobs" class="btn">‚Üê Wszystkie zadania</a>
        <div class="phone-number">üìû +48 533 193 112</div>
        <form method="post" action="/logout">
          <button type="submit" class="btn">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <h1>Szczeg√≥≈Çy zadania #<%= job.id %></h1>

      <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
          <!-- Basic Information -->
          <div>
            <h2 style="margin-top: 0;">Informacje podstawowe</h2>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
              <strong>ID zadania:</strong>
              <span><%= job.id %></span>

              <strong>Klient:</strong>
              <span><%= job.user_email %></span>

              <strong>Status:</strong>
              <span>
                <%
                const statusMap = {
                  'pending': 'OczekujƒÖce',
                  'completed': 'Zako≈Ñczone',
                  'processing': 'W trakcie',
                  'cancelled': 'Anulowane'
                };
                %>
                <%= statusMap[job.status] || job.status %>
              </span>

              <strong>Data utworzenia:</strong>
              <span><%= job.created_at %></span>

              <strong>Ostatnia aktualizacja:</strong>
              <span>
                <%= job.updated_at %>
                <%
                const created = new Date(job.created_at);
                const updated = new Date(job.updated_at);
                const diffMs = updated - created;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins > 1) {
                %>
                <span style="color: #059669; font-size: 0.8rem; margin-left: 0.5rem;">(edytowane)</span>
                <%
                }
                %>
              </span>
            </div>
          </div>

          <!-- File Information -->
          <div>
            <h2 style="margin-top: 0;">Informacje o pliku</h2>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
              <strong>Nazwa oryginalna:</strong>
              <span><%= job.original_filename %></span>

              <strong>Rozmiar pliku:</strong>
              <span><%= fileSize %></span>

              <strong>Plik przetworzony:</strong>
              <span><%= job.processed_filename ? 'Tak' : 'Nie' %></span>
            </div>

            <div style="margin-top: 1rem;">
              <a href="/admin/jobs/<%= job.id %>/original" class="btn" style="margin-right: 1rem;">Pobierz plik oryginalny</a>
              <% if (job.processed_filename) { %>
              <a href="/admin/jobs/<%= job.id %>/processed" class="btn btn-primary">Pobierz plik przetworzony</a>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Vehicle Information -->
        <div style="margin-bottom: 2rem;">
          <h2>Informacje o poje≈∫dzie</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
              <strong>Marka:</strong><br>
              <%= job.vehicle_make || 'Nie podano' %>
            </div>
            <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
              <strong>Model:</strong><br>
              <%= job.vehicle_model || 'Nie podano' %>
            </div>
            <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
              <strong>Rok produkcji:</strong><br>
              <%= job.vehicle_year || 'Nie podano' %>
            </div>
            <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
              <strong>Sterownik ECU:</strong><br>
              <%= job.ecu_controller || 'Nie podano' %>
            </div>
          </div>
        </div>

        <!-- Tuning Options -->
        <div style="margin-bottom: 2rem;">
          <h2>Wybrane opcje tuningu</h2>
          <%
          const opts = JSON.parse(job.options || '{}');
          const optionLabels = {
            'dpf_off': 'Wy≈ÇƒÖczenie filtra czƒÖstek sta≈Çych (DPF)',
            'egr_off': 'Wy≈ÇƒÖczenie recyrkulacji spalin (EGR)',
            'adblue_off': 'Wy≈ÇƒÖczenie systemu AdBlue/SCR',
            'dtc_off': 'Wy≈ÇƒÖczenie kod√≥w b≈Çƒôd√≥w DTC',
            'immo_off': 'Wy≈ÇƒÖczenie immobilisera (IMMO)'
          };
          %>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <% Object.keys(optionLabels).forEach(function(key) { %>
            <div class="<%= opts[key] ? 'option-selected' : 'option-not-selected' %>">
              <strong><%= optionLabels[key] %></strong><br>
              <span class="<%= opts[key] ? 'option-text-selected' : 'option-text-not-selected' %>">
                <%= opts[key] ? '‚úì Wybrane' : '‚úó Nie wybrane' %>
              </span>
            </div>
            <% }); %>
          </div>

          <% if (opts.dtc_codes) { %>
          <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #d97706;">
            <strong>Kody b≈Çƒôd√≥w DTC do wy≈ÇƒÖczenia:</strong><br>
            <span style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; display: inline-block;">
              <%= opts.dtc_codes %>
            </span>
          </div>
          <% } %>
        </div>

        <!-- Notes -->
        <% if (job.notes) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Notatki klienta</h2>
          <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; border-left: 4px solid #6b7280;">
            <%= job.notes.replace(/\n/g, '<br>') %>
          </div>
        </div>
        <% } %>

        <!-- Client Message -->
        <div style="margin-bottom: 2rem;">
          <h2>Wiadomo≈õƒá dla klienta</h2>
          <form method="post" action="/admin/jobs/<%= job.id %>/update_message">
            <textarea name="client_message" rows="4" placeholder="Wpisz wiadomo≈õƒá dla klienta" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"><%= job.client_message || '' %></textarea>
            <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">Zapisz wiadomo≈õƒá</button>
          </form>
        </div>

        <!-- Chat -->
        <div style="margin-bottom: 2rem;">
          <h2>Czat</h2>
          <div id="chat-messages" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; height: 200px; overflow-y: auto; background: #f9fafb; margin-bottom: 1rem;">
            <!-- Messages will be loaded here -->
          </div>
          <form id="chat-form" style="display: flex; gap: 0.5rem;">
            <input type="text" id="chat-input" placeholder="Wpisz wiadomo≈õƒá..." style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" required />
            <button type="submit" class="btn btn-primary">Wy≈õlij</button>
          </form>
        </div>

        <!-- Upload Processed File -->
        <% if (!job.processed_filename) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Prze≈õlij plik przetworzony</h2>
          <form method="post" action="/admin/jobs/<%= job.id %>/complete" enctype="multipart/form-data" style="display: flex; gap: 1rem; align-items: center;">
            <input type="file" name="processed_file" required style="flex: 1;" />
            <button type="submit" class="btn btn-primary">Prze≈õlij plik</button>
          </form>
        </div>
        <% } %>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
          <a href="/admin/jobs" class="btn">‚Üê Powr√≥t do listy zada≈Ñ</a>
          <a href="/admin/jobs/<%= job.id %>/original" class="btn">Pobierz oryginalny plik</a>
          <% if (job.processed_filename) { %>
          <a href="/admin/jobs/<%= job.id %>/processed" class="btn btn-primary">Pobierz przetworzony plik</a>
          <% } %>
          <% if (job.status !== 'completed') { %>
          <form method="post" action="/admin/jobs/<%= job.id %>/cancel" style="display: inline;">
            <button type="submit" class="btn" style="background: #dc2626; color: white;">Anuluj zlecenie</button>
          </form>
          <% } %>
        </div>
      </div>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const jobId = <%= job.id %>;
      const chatMessages = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');

      socket.emit('joinJob', jobId);

      function loadMessages() {
        fetch(`/api/jobs/${jobId}/messages`)
          .then(res => res.json())
          .then(messages => {
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.style.marginBottom = '0.5rem';
              div.style.padding = '0.5rem';
              div.style.borderRadius = '0.375rem';
              div.style.background = msg.user_role === 'admin' ? '#e0f2fe' : '#f3f4f6';
              div.innerHTML = '<strong style="color: ' + (msg.user_role === 'admin' ? 'red' : 'darkblue') + ';">' + msg.user_name + ':</strong> ' + msg.message;
              chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
          });
      }

      loadMessages();

      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          fetch(`/api/jobs/${jobId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          })
          .then(res => res.json())
          .then(data => {
            chatInput.value = '';
          });
        }
      });

      socket.on('newMessage', (message) => {
        loadMessages();
      });
    </script>
  </body>
  </html>
