<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Szczeg√≥≈Çy zadania #<%= job.id %> - Serwis Plik√≥w</title>
    <link rel="stylesheet" href="/tfs/tfs/styles.css" />
  </head>
  <body>
    <header class="top-bar">
      <div class="logo">Panel administracyjny</div>
      <nav>
        <a href="/tfs/tfs/admin/jobs" class="btn">Zadania</a>
        <a href="/tfs/tfs/admin/complaints" class="btn" id="complaints-btn">Reklamacje</a>
        <a href="/tfs/tfs/admin/users" class="btn">U≈ºytkownicy</a>
        <div class="phone-number">üìû +48 533 193 112</div>
        <form method="post" action="/tfs/tfs/logout">
          <button type="submit" class="btn">Wyloguj</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <h1>Szczeg√≥≈Çy zadania #<%= job.id %></h1>
      <div id="notification" style="display: none; background: #10b981; color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        Nowe zadanie zosta≈Ço dodane przez u≈ºytkownika!
      </div>

      <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
          <!-- Chat (Left Side) -->
          <div>
            <h2 style="margin-top: 0;">Czat</h2>
            <div id="chat-messages" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; height: 300px; overflow-y: auto; background: #f9fafb; margin-bottom: 1rem;">
              <!-- Messages will be loaded here -->
            </div>
            <form id="chat-form" style="display: flex; gap: 0.5rem;">
              <input type="text" id="chat-input" placeholder="Wpisz wiadomo≈õƒá..." style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" required />
              <button type="submit" class="btn btn-primary">Wy≈õlij</button>
            </form>
          </div>

          <!-- Information Sections (Right Side) -->
          <div>
            <!-- Basic Information -->
            <div style="margin-bottom: 2rem;">
              <h2 style="margin-top: 0;">Informacje podstawowe</h2>
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                <strong>ID zadania:</strong>
                <span><%= job.id %></span>

                <strong>Klient:</strong>
                <span><%= job.user_email %></span>

                <strong>Status:</strong>
                <span>
                  <%
                  const statusMap = {
                    'pending': 'OczekujƒÖce',
                    'completed': 'Zako≈Ñczone',
                    'processing': 'W trakcie',
                    'cancelled': 'Anulowane'
                  };
                  %>
                  <%= statusMap[job.status] || job.status %>
                </span>

                <strong>Data utworzenia:</strong>
                <span><%= job.created_at %></span>

                <strong>Ostatnia aktualizacja:</strong>
                <span>
                  <%= job.updated_at %>
                  <%
                  const created = new Date(job.created_at);
                  const updated = new Date(job.updated_at);
                  const diffMs = updated - created;
                  const diffMins = Math.floor(diffMs / 60000);
                  if (diffMins > 1) {
                  %>
                  <span style="color: #059669; font-size: 0.7rem; margin-left: 0.25rem;">(edytowane)</span>
                  <%
                  }
                  %>
                </span>
              </div>
            </div>

            <!-- File Information -->
            <div style="margin-bottom: 2rem;">
              <h2>Informacje o pliku</h2>
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                <strong>Nazwa oryginalna:</strong>
                <span><%= job.original_filename %></span>

                <strong>Rozmiar pliku:</strong>
                <span><%= fileSize %></span>

                <strong>Plik przetworzony:</strong>
                <span><%= job.processed_filename ? 'Tak' : 'Nie' %></span>
              </div>

              <div style="margin-top: 1rem;">
                <a href="/tfs/tfs/admin/jobs/<%= job.id %>/original" class="btn" style="margin-right: 1rem;">Pobierz plik oryginalny</a>
                <% if (job.processed_filename) { %>
                <a href="/tfs/tfs/admin/jobs/<%= job.id %>/processed" class="btn btn-primary">Pobierz plik przetworzony</a>
                <% } %>
              </div>
            </div>

            <!-- Vehicle Information -->
            <div style="margin-bottom: 2rem;">
              <h2>Informacje o poje≈∫dzie</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Marka:</strong><br>
                  <%= job.vehicle_make || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Model:</strong><br>
                  <%= job.vehicle_model || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Rok produkcji:</strong><br>
                  <%= job.vehicle_year || 'Nie podano' %>
                </div>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                  <strong>Sterownik ECU:</strong><br>
                  <%= job.ecu_controller || 'Nie podano' %>
                </div>
              </div>
            </div>

            <!-- Tuning Options -->
            <div style="margin-bottom: 2rem;">
              <h2>Wybrane opcje tuningu</h2>
              <%
              const opts = JSON.parse(job.options || '{}');
              const optionLabels = {
                'dpf_off': 'DPF OFF',
                'egr_off': 'EGR OFF',
                'adblue_off': 'AdBlue OFF',
                'dtc_off': 'DTC OFF',
                'immo_off': 'IMMO OFF'
              };
              %>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <% Object.keys(optionLabels).forEach(function(key) { %>
                <div class="<%= opts[key] ? 'option-selected' : 'option-not-selected' %>">
                  <strong><%= optionLabels[key] %></strong><br>
                  <span class="<%= opts[key] ? 'option-text-selected' : 'option-text-not-selected' %>">
                    <%= opts[key] ? '‚úì' : '‚úó' %>
                  </span>
                </div>
                <% }); %>
              </div>

              <% if (opts.dtc_codes) { %>
              <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #d97706;">
                <strong>Kody b≈Çƒôd√≥w DTC:</strong><br>
                <span style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; display: inline-block;">
                  <%= opts.dtc_codes %>
                </span>
              </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <% if (job.notes) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Notatki klienta</h2>
          <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; border-left: 4px solid #6b7280;">
            <%= job.notes.replace(/\n/g, '<br>') %>
          </div>
        </div>
        <% } %>

        <!-- Client Message -->
        <div style="margin-bottom: 2rem;">
          <h2>Wiadomo≈õƒá dla klienta</h2>
          <form method="post" action="/tfs/tfs/admin/jobs/<%= job.id %>/update_message">
            <textarea name="client_message" rows="4" placeholder="Wpisz wiadomo≈õƒá dla klienta" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"><%= job.client_message || '' %></textarea>
            <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">Zapisz wiadomo≈õƒá</button>
          </form>
        </div>

        <!-- Problem Report -->
        <% if (job.problem_status === 'open') { %>
        <div style="margin-bottom: 2rem;">
          <h2>Zg≈Çoszony problem</h2>
          <div style="padding: 1rem; background: #fef2f2; border-radius: 0.5rem; border-left: 4px solid #dc2626;">
            <%= job.problem_description || 'Brak opisu problemu' %>
          </div>
        </div>
        <% } %>

        <!-- Upload Processed File -->
        <% if (!job.processed_filename) { %>
        <div style="margin-bottom: 2rem;">
          <h2>Prze≈õlij plik przetworzony</h2>
          <form method="post" action="/tfs/admin/jobs/<%= job.id %>/complete" enctype="multipart/form-data" style="display: flex; gap: 1rem; align-items: center;">
            <input type="file" name="processed_file" required style="flex: 1;" />
            <button type="submit" class="btn btn-primary">Prze≈õlij plik</button>
          </form>
        </div>
        <% } %>

        <!-- Problem Resolution -->
        <% if (job.problem_status === 'open') { %>
        <div style="margin-bottom: 2rem;">
          <h2>RozwiƒÖzywanie problemu</h2>
          <p>Klient zg≈Çosi≈Ç problem ze zleceniem. Mo≈ºesz przes≈Çaƒá poprawionƒÖ wersjƒô pliku lub po przedyskutowaniu problemu w czacie kliknƒÖƒá "Zako≈Ñcz".</p>

          <h3>Prze≈õlij poprawionƒÖ wersjƒô pliku</h3>
          <form method="post" action="/tfs/admin/jobs/<%= job.id %>/upload_corrected" enctype="multipart/form-data" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input type="file" name="corrected_file" required />
              <button type="submit" class="btn btn-primary">Prze≈õlij poprawiony plik</button>
            </div>
            <small style="color: #6b7280;">Aktualna wersja pliku: <%= job.file_version || 1 %></small>
          </form>

          <form method="post" action="/tfs/admin/jobs/<%= job.id %>/close_problem" style="display: inline;">
            <button type="submit" class="btn" style="background: #16a34a; color: white;">Zako≈Ñcz zg≈Çoszenie problemu</button>
          </form>
        </div>
        <% } %>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
          <a href="/tfs/admin/jobs" class="btn">‚Üê Powr√≥t do listy zada≈Ñ</a>
          <a href="/tfs/admin/jobs/<%= job.id %>/original" class="btn">Pobierz oryginalny plik</a>
          <% if (job.processed_filename) { %>
          <a href="/tfs/admin/jobs/<%= job.id %>/processed" class="btn btn-primary">Pobierz przetworzony plik</a>
          <% } %>
          <% if (job.status !== 'completed') { %>
          <form method="post" action="/tfs/admin/jobs/<%= job.id %>/cancel" style="display: inline;">
            <button type="submit" class="btn" style="background: #dc2626; color: white;">Anuluj zlecenie</button>
          </form>
          <% } %>
        </div>
      </div>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const jobId = <%= job.id %>;
      const chatMessages = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');

      socket.emit('joinJob', jobId);

      function loadMessages() {
        fetch(`/api/jobs/${jobId}/messages`)
          .then(res => res.json())
          .then(messages => {
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.style.marginBottom = '0.5rem';
              div.style.padding = '0.5rem';
              div.style.borderRadius = '0.375rem';
              div.style.background = msg.user_role === 'admin' ? '#e0f2fe' : '#f3f4f6';
              div.innerHTML = '<strong style="color: ' + (msg.user_role === 'admin' ? 'red' : 'darkblue') + ';">' + msg.user_name + ':</strong> ' + msg.message;
              chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
          });
      }

      loadMessages();

      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          fetch(`/api/jobs/${jobId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          })
          .then(res => res.json())
          .then(data => {
            chatInput.value = '';
          });
        }
      });

      socket.on('newMessage', (message) => {
        loadMessages();
      });

      socket.emit('joinAdmin');

      socket.on('newJob', (jobData) => {
        const notification = document.getElementById('notification');
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 5000); // Hide after 5 seconds
      });

      // Check for open problems and highlight complaints button
      function checkProblems() {
        fetch('/api/admin/open-problems')
          .then(res => res.json())
          .then(problems => {
            const complaintsBtn = document.getElementById('complaints-btn');
            if (problems.length > 0) {
              complaintsBtn.style.backgroundColor = '#dc2626';
              complaintsBtn.style.color = 'white';
              complaintsBtn.style.border = '2px solid #dc2626';
            } else {
              complaintsBtn.style.backgroundColor = '#e5e7eb';
              complaintsBtn.style.color = '#111827';
              complaintsBtn.style.border = 'none';
            }
          })
          .catch(err => console.error('Error checking open problems:', err));
      }

      checkProblems();
    </script>
  </body>
  </html>
